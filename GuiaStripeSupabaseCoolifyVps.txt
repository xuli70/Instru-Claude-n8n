(Stripe + Supabase + Coolify en VPS) 

A continuaci√≥n encontrar√°s el contenido √≠ntegro del documento original, pero organizado en secciones l√≥gicas y jer√°rquicas para que puedas localizar cualquier parte con rapidez sin perder ning√∫n detalle t√©cnico ni de c√≥digo.

√çndice
Arquitectura del sistema

Stack tecnol√≥gico

Estructura del proyecto

Contenedorizaci√≥n y deployment

Variables de entorno y entrypoint

Configuraci√≥n central del frontend

Funciones Supabase

Funciones Stripe

L√≥gica principal de la aplicaci√≥n

Esquema de base de datos

Variables de entorno en Coolify

Backend m√≠nimo (Node.js)

Sistema de debug y monitoreo

Seguridad y buenas pr√°cticas

Flujo completo de compra

Checklist de deployment

Tips Pro

Recursos esenciales

Metadatos finales

1. Arquitectura del sistema 
scss
Copiar
Editar
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     HTTPS      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Tu Dominio    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ   Coolify VPS    ‚îÇ
‚îÇ app.ejemplo.com ‚îÇ                 ‚îÇ   (Hostinger)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚îÇ
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ                 ‚îÇ
                              API Calls         API Calls
                                    ‚îÇ                 ‚îÇ
                                    ‚ñº                 ‚ñº
                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                          ‚îÇ   Supabase   ‚îÇ  ‚îÇ    Stripe    ‚îÇ
                          ‚îÇ (Base Datos) ‚îÇ  ‚îÇ   (Pagos)    ‚îÇ
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
2. Stack tecnol√≥gico 
Frontend: HTML, CSS, JavaScript vanilla

Base de datos: Supabase (PostgreSQL)

Pagos: Stripe Checkout

Deployment: Coolify + Docker

Servidor web: Caddy

VPS: Hostinger

Seguridad: Variables de entorno + RLS

3. Estructura del proyecto 
text
Copiar
Editar
mi-app-stripe-supabase/
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ styles.css
‚îú‚îÄ‚îÄ config.js
‚îú‚îÄ‚îÄ supabase.js
‚îú‚îÄ‚îÄ stripe.js
‚îú‚îÄ‚îÄ products.js
‚îú‚îÄ‚îÄ app.js
‚îú‚îÄ‚îÄ entrypoint.sh
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ server.js
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ README.md
4. Contenedorizaci√≥n y deployment 
4.1 Dockerfile universal para Coolify
dockerfile
Copiar
Editar
# Dockerfile para app con Stripe + Supabase
FROM node:18-alpine
WORKDIR /app
RUN apk add --no-cache caddy
COPY *.html ./
COPY *.css ./
COPY *.js ./
COPY entrypoint.sh ./
RUN chmod +x /app/entrypoint.sh
RUN echo -e ":${PORT:-8080} {\n\
    root * /app\n\
    file_server\n\
    try_files {path} /index.html\n\
    \n\
    # Headers de seguridad\n\
    header {\n\
        X-Content-Type-Options nosniff\n\
        X-Frame-Options DENY\n\
        X-XSS-Protection \"1; mode=block\"\n\
        Referrer-Policy strict-origin-when-cross-origin\n\
        Content-Security-Policy \"default-src 'self' https:; script-src 'self' 'unsafe-inline' https://js.stripe.com; style-src 'self' 'unsafe-inline'; frame-src https://js.stripe.com https://hooks.stripe.com;\"\n\
    }\n\
    \n\
    # CORS para APIs\n\
    header Access-Control-Allow-Origin *\n\
    header Access-Control-Allow-Methods \"GET, POST, PUT, DELETE, OPTIONS\"\n\
    header Access-Control-Allow-Headers \"Content-Type, Authorization, X-Requested-With\"\n\
    \n\
    # Proxy para backend (si lo tienes)\n\
    @api {\n\
        path /api/*\n\
    }\n\
    reverse_proxy @api localhost:3000\n\
}" > /app/Caddyfile
EXPOSE 8080
CMD [\"/app/entrypoint.sh\"]
5. Variables de entorno y entrypoint 
5.1 Script entrypoint.sh
bash
Copiar
Editar
#!/bin/sh
# Script universal para inyectar variables de Stripe y Supabase
echo "üöÄ Iniciando aplicaci√≥n..."

cat > /app/env.js << EOF
// Variables de entorno inyectadas por Coolify
window.ENV = {
    // === SUPABASE ===
    SUPABASE_URL: "${SUPABASE_URL}",
    SUPABASE_ANON_KEY: "${SUPABASE_ANON_KEY}",
    
    // === STRIPE ===
    STRIPE_PUBLIC_KEY: "${STRIPE_PUBLIC_KEY}",
    STRIPE_WEBHOOK_SECRET: "${STRIPE_WEBHOOK_SECRET}",
    
    // === BACKEND ===
    API_URL: "${API_URL:-http://localhost:3000}",
    
    // === CONFIGURACI√ìN ===
    APP_MODE: "${APP_MODE:-development}",
    ENABLE_DEBUG: "${ENABLE_DEBUG:-false}"
};
...
exec caddy run --config /app/Caddyfile --adapter caddyfile
6. Configuraci√≥n central del frontend (config.js) 
javascript
Copiar
Editar
// === CONFIGURACI√ìN MAESTRA ===
if (!window.ENV) {
    console.error('‚ùå Variables de entorno no cargadas');
    alert('Error de configuraci√≥n. Contacta al administrador.');
}

const SUPABASE_CONFIG = { ... };
const STRIPE_CONFIG   = { ... };
const API_CONFIG      = { ... };
const APP_CONFIG      = { ... };

function validateConfig() { ... }

document.addEventListener('DOMContentLoaded', validateConfig);
(el bloque incluye toda la l√≥gica de validaci√≥n y feature flags original)

7. Funciones Supabase (supabase.js) 
javascript
Copiar
Editar
// === FUNCIONES SUPABASE ===
function getSupabaseUrl(endpoint) { ... }
async function supabaseCreate(table, data) { ... }
async function supabaseRead(table, filters = '') { ... }
async function supabaseUpdate(table, id, data) { ... }
async function supabaseDelete(table, id) { ... }
async function guardarOrdenEnSupabase(orderData) { ... }
async function actualizarEstadoPago(sessionId, status) { ... }
8. Funciones Stripe (stripe.js) 
javascript
Copiar
Editar
// === FUNCIONES STRIPE ===
let stripe = null;
function initializeStripe() { ... }
async function createCheckoutSession(items) { ... }
async function redirectToCheckout(sessionId) { ... }
async function procesarPago(carrito) { ... }
async function verificarPago() { ... }

document.addEventListener('DOMContentLoaded', () => {
    initializeStripe();
    verificarPago();
});
9. L√≥gica principal de la aplicaci√≥n (app.js) 
javascript
Copiar
Editar
// === APLICACI√ìN PRINCIPAL ===
let carrito   = JSON.parse(localStorage.getItem('carrito')) || [];
let productos = [];
let usuario   = null;

async function initApp() { ... }
async function cargarProductos() { ... }
function mostrarProductos(productos) { ... }
function agregarAlCarrito(productoId) { ... }
function guardarCarrito() { ... }
function actualizarUICarrito() { ... }
async function procesarCheckout() { ... }
...
document.addEventListener('DOMContentLoaded', initApp);
10. Esquema de base de datos (SQL) 
sql
Copiar
Editar
-- Tabla de productos
CREATE TABLE products (...);

-- Tabla de √≥rdenes
CREATE TABLE orders (...);

-- Tabla de clientes (opcional)
CREATE TABLE customers (...);

-- √çndices
CREATE INDEX idx_orders_session_id ON orders(stripe_session_id);
CREATE INDEX idx_orders_status     ON orders(status);
CREATE INDEX idx_customers_email   ON customers(email);

-- RLS
ALTER TABLE products  ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders    ENABLE ROW LEVEL SECURITY;
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;

-- Pol√≠ticas
CREATE POLICY "Products son p√∫blicos"  ON products FOR SELECT USING (true);
CREATE POLICY "Orders solo lectura propia" ON orders
    FOR SELECT USING (auth.email() = customer_email);
11. Variables de entorno en Coolify 
env
Copiar
Editar
# === SUPABASE ===
SUPABASE_URL=https://tu-proyecto.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIs...

# === STRIPE ===
STRIPE_PUBLIC_KEY=pk_test_51ABC...
STRIPE_SECRET_KEY=sk_test_51ABC...
STRIPE_WEBHOOK_SECRET=whsec_...

# === APLICACI√ìN ===
API_URL=https://tu-backend.com
APP_MODE=production
ENABLE_DEBUG=false

# === OPCIONAL ===
SENTRY_DSN=https://...
ANALYTICS_ID=G-...
12. Backend m√≠nimo (Node.js) 
javascript
Copiar
Editar
const express = require('express');
const stripe  = require('stripe')(process.env.STRIPE_SECRET_KEY);
const cors    = require('cors');
const app     = express();

app.use(cors());
app.use(express.json());

app.post('/api/stripe/create-checkout-session', async (req, res) => { ... });
app.post('/api/stripe/webhook', express.raw({ type: 'application/json' }), async (req, res) => { ... });

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Backend corriendo en puerto ${PORT}`));
13. Sistema de debug y monitoreo 
javascript
Copiar
Editar
const Debug = {
    enabled: APP_CONFIG.debug,
    log(...args)   { ... },
    error(...args) { ... },
    table(data)    { ... },
    showPanel()    { ... },
    clearData()    { ... },
    testPayment()  { ... }
};
14. Seguridad y buenas pr√°cticas 
RLS en Supabase

sql
Copiar
Editar
CREATE POLICY "public_products" ON products FOR SELECT USING (true);
CREATE POLICY "own_orders"     ON orders   FOR SELECT USING (auth.email() = customer_email);
Validaci√≥n de datos

javascript
Copiar
Editar
function validarEmail(email)  { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
function validarPrecio(precio){ return typeof precio === 'number' && precio >= 50; }
Sanitizaci√≥n

javascript
Copiar
Editar
function sanitizeHtml(str){
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
HTTPS siempre

Coolify gestiona SSL autom√°ticamente.

Nunca env√≠es datos sensibles por HTTP.

15. Flujo completo de compra 
markdown
Copiar
Editar
1. Usuario navega productos (Supabase)
   ‚Üì
2. Agrega al carrito (localStorage)
   ‚Üì
3. Click en "Pagar"
   ‚Üì
4. Frontend env√≠a carrito al backend
   ‚Üì
5. Backend crea sesi√≥n con Stripe
   ‚Üì
6. Frontend guarda orden en Supabase (pending)
   ‚Üì
7. Redirige a Stripe Checkout
   ‚Üì
8. Usuario completa pago
   ‚Üì
9. Stripe env√≠a webhook al backend
   ‚Üì
10. Backend actualiza orden en Supabase (completed)
    ‚Üì
11. Usuario regresa a success page
    ‚Üì
12. Frontend verifica y muestra confirmaci√≥n
16. Checklist de deployment 
 Dockerfile con puerto 8080

 entrypoint.sh ejecutable

 Variables en Coolify configuradas

 Supabase: tablas creadas y RLS activo

 Stripe: claves configuradas y webhooks

 Backend desplegado (si lo usas)

 Dominio con SSL

 Testing en modo prueba

 Logs y monitoreo activos

17. Tips Pro 
Stripe CLI para test local

bash
Copiar
Editar
stripe listen --forward-to localhost:3000/api/stripe/webhook
Supabase Realtime para actualizaciones

javascript
Copiar
Editar
const subscription = supabase
  .from('orders')
  .on('UPDATE', payload => {
    console.log('Orden actualizada:', payload);
  })
  .subscribe();
Cache de productos

javascript
Copiar
Editar
const CACHE_KEY = 'products_cache';
const CACHE_TTL = 5 * 60 * 1000;
async function getProductosCached() { ... }
18. Recursos esenciales 
Stripe Testing: https://stripe.com/docs/testing

Supabase JS Client: https://supabase.com/docs/reference/javascript

Coolify Docs: https://coolify.io/docs

Ejemplos de c√≥digo Stripe: https://github.com/stripe/stripe-samples

19. Metadatos finales 
Stack completo: Stripe + Supabase + Coolify + VPS

Creado para: Tu entorno espec√≠fico

Mantenido por: Tu conocimiento acumulado

√öltima actualizaci√≥n: Enero 2025

